# WebSocket 调试工具使用指南

## 概述

WebSocket调试工具是一个强大的开发和调试工具，允许您实时监控和测试WebSocket连接，特别是针对Maicraft Web UI中的各种监控服务。

## 功能特性

### 🔍 **实时消息监控**

- 实时显示所有WebSocket消息
- 支持JSON格式化显示
- 消息历史记录和搜索
- 自动滚动和手动滚动控制

### 🔧 **多端点支持**

- **Token使用量监控**: `/ws/token-usage`
- **Minecraft日志**: `/ws/logs`
- **事件监控**: `/ws/events`
- **玩家状态**: `/ws/game/player`
- **世界状态**: `/ws/game/world`
- **任务管理器**: `/ws/task-manager`
- **状态监控**: `/ws/status`
- **通用端点**: `/ws`

### 📤 **消息发送功能**

- 预设消息模板
- 自定义JSON消息发送
- 消息历史和重发

### 📊 **连接状态监控**

- 实时连接状态显示
- 连接时间统计
- 消息计数统计
- 错误处理和重连机制

## 使用方法

### 1. 访问调试工具

在侧边栏中点击 **"WebSocket 调试"** 菜单项，或直接访问：

```
http://localhost:5173/websocket-debugger
```

### 2. 选择WebSocket端点

在"WebSocket 端点"下拉菜单中选择要调试的端点：

- **Token使用量监控**: 调试Token监控功能
- **Minecraft日志**: 调试日志实时推送
- **事件监控**: 调试事件系统
- 其他端点根据需要选择

### 3. 连接WebSocket

1. 选择端点后，点击 **"连接"** 按钮
2. 观察连接状态变化为"已连接"
3. 查看连接信息面板中的详细信息

### 4. 监控消息

连接成功后，您将看到：

- **接收消息**: 服务端推送的数据
- **发送消息**: 您发送的命令
- 每条消息包含时间戳和消息类型

### 5. 发送测试消息

#### 预设消息

- **ping**: 测试连接心跳
- **订阅**: 订阅数据更新
- **取消订阅**: 停止数据更新

#### Token监控专用

- **订阅Token**: 开始监控Token使用量
- **获取使用量**: 获取当前Token统计

#### 自定义消息

在文本框中输入JSON格式的消息，例如：

```json
{
  "type": "subscribe",
  "update_interval": 2000,
  "model_filter": "gpt"
}
```

## 调试场景

### 🔍 **Token监控调试**

1. 选择 **"Token使用量监控"** 端点
2. 点击 **"连接"**
3. 点击 **"订阅Token"** 按钮
4. 观察是否有Token使用数据推送
5. 如果没有数据，检查：
   - 服务端是否正在运行
   - 是否有AI模型在使用中
   - 服务端日志是否有错误

### 📊 **连接问题排查**

如果连接失败，检查：

1. **服务端状态**: 确保Maicraft服务正在运行
2. **端口配置**: 确认端口20914是否正确
3. **网络连接**: 检查防火墙和网络设置
4. **WebSocket URL**: 验证URL格式是否正确

### 🔄 **消息格式验证**

使用调试工具验证：

1. **数据格式**: 检查推送的数据格式是否符合预期
2. **消息类型**: 确认消息类型是否正确
3. **时间戳**: 验证时间戳是否准确
4. **数据完整性**: 检查是否有数据丢失或损坏

## 高级功能

### 📋 **消息过滤**

- 使用JSON格式化开关控制显示格式
- 手动滚动查看历史消息
- 消息计数统计

### 🔄 **自动重连**

工具内置重连机制：

- 连接断开后自动重试
- 可配置重连间隔和最大重试次数
- 连接恢复后自动重新订阅

### 📝 **消息历史**

- 保存所有消息历史
- 支持清空历史记录
- 实时消息计数更新

## 故障排除

### 连接失败

**问题**: 无法建立WebSocket连接

**解决方案**:

1. 检查服务端是否启动: `netstat -ano | findstr 20914`
2. 验证端口配置
3. 检查防火墙设置
4. 查看浏览器控制台错误信息

### 无数据推送

**问题**: 连接成功但没有收到数据

**解决方案**:

1. 发送订阅消息
2. 检查服务端是否有数据产生
3. 验证消息过滤条件
4. 查看服务端日志

### 消息格式错误

**问题**: 收到格式异常的消息

**解决方案**:

1. 使用JSON格式化查看原始数据
2. 检查服务端代码逻辑
3. 验证API文档与实现的一致性

## 技术细节

### WebSocket协议

- 使用标准WebSocket协议 (ws://)
- 支持心跳机制 (ping/pong)
- 自动重连和错误恢复
- JSON消息格式

### 消息类型

- `token_usage_update`: Token使用量更新
- `log`: 日志消息
- `event`: 事件通知
- `ping/pong`: 心跳消息
- `subscribe/unsubscribe`: 订阅控制

### 性能优化

- 消息缓冲和批量处理
- 自动滚动优化
- 内存使用监控
- 连接状态缓存

## 开发指南

### 添加新端点

在 `availableEndpoints` 数组中添加新的端点配置：

```typescript
{
  key: 'NEW_ENDPOINT',
  label: '新端点名称',
  url: 'ws://localhost:20914/ws/new-endpoint'
}
```

### 自定义消息处理

扩展消息处理器以支持新的消息类型和格式。

### 样式定制

修改CSS样式以适应特定的UI需求和主题。

## 相关文档

- [API文档](../api/api.md)
- [Token使用量监控文档](../api/token-usage.md)
- [WebSocket服务文档](../services/websocket.ts)

---

_最后更新: 2025-09-20_
